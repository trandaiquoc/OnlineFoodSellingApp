USE master
GO
IF DB_ID ('QLBH') IS NOT NULL
	DROP DATABASE QLBH
GO
CREATE DATABASE QLBH
GO
USE QLBH
GO
CREATE TABLE TAIKHOAN 
(
	MATK VARCHAR(10),
	TENTK VARCHAR(100), CHECK(TENTK IS NOT NULL),
	MATKHAU VARCHAR(100), CHECK(MATKHAU IS NOT NULL),
	LOAITK INT CHECK(LOAITK >= 0 AND LOAITK <= 4 AND LOAITK IS NOT NULL)
	

	CONSTRAINT PK_TK
	PRIMARY KEY (MATK)
)
CREATE TABLE NHANVIEN
(
	MANV VARCHAR(10),
	TEN NVARCHAR(100),
	EMAIL VARCHAR(100),
	SDT VARCHAR(20),
	AD BIT, CHECK(AD IS NOT NULL),
	MATK VARCHAR(10)

	CONSTRAINT PK_NV
	PRIMARY KEY (MANV)
)

CREATE TABLE KHACHHANG 
(
	MAKH VARCHAR(10),
	TEN NVARCHAR(100),
	EMAIL VARCHAR(100),
	SDT VARCHAR(20),
	DIACHI NVARCHAR(100),
	MATK VARCHAR(10)

	CONSTRAINT PK_KH
	PRIMARY KEY (MAKH)
)

CREATE TABLE TAIXE
(
	MATX VARCHAR(10),
	TEN NVARCHAR(100),
	EMAIL VARCHAR(100),
	SDT VARCHAR(20),
	DIACHI NVARCHAR(100),
	CMND VARCHAR(20),
	BIENSOXE CHAR(9),
	KHUVUCHOATDONG NVARCHAR(100),
	SOTAIKHOAN VARCHAR(20),
	NGANHANG VARCHAR(100),
	CHINHANHNGANHANG VARCHAR(20),
	MATK VARCHAR(10)

	CONSTRAINT PK_TX
	PRIMARY KEY (MATX)
)

CREATE TABLE DOITAC
(
	MADT VARCHAR(10),
	TENQUAN NVARCHAR(100),
	EMAIL VARCHAR(100),
	SDT VARCHAR(20),
	NGUOIDAIDIEN NVARCHAR(100),
	DIACHITRUSOCHINH NVARCHAR(100),
	SLCUAHANG INT,
	SLDONMOINGAY VARCHAR(10),
	LOAIAMTHUC NVARCHAR(100),
	MASOTHUE VARCHAR(20),
	DOANHSOBAN MONEY,
	MATK VARCHAR(10)

	CONSTRAINT PK_DT
	PRIMARY KEY (MADT)
)

CREATE TABLE HOPDONG
(
	MAHD VARCHAR(10),
	NGAYBATDAU DATE,
	NGAYKETTHUC DATE,
	TINHTRANG NVARCHAR(100), CHECK(TINHTRANG IS NOT NULL),
	SOTAIKHOAN VARCHAR(20),
	NGANHANG VARCHAR(100),
	CHINHANHNGANHANG VARCHAR(20),
	PHANTRAMHOAHONG FLOAT,
	MADT VARCHAR(10),
	NVDUYET VARCHAR(10)

	CONSTRAINT PK_HD
	PRIMARY KEY (MAHD)
)

CREATE TABLE CUAHANG
(
	MADT VARCHAR(10),
	STT INT, CHECK(STT > 0),
	TEN NVARCHAR(100),
	DIACHI NVARCHAR(100),
	THOIGIANMOCUA TIME,
	THOIGIANDONGCUA TIME,
	TINHTRANG BIT, CHECK(TINHTRANG IS NOT NULL),

	CONSTRAINT PK_CH
	PRIMARY KEY (MADT,STT)
)

CREATE TABLE MONAN
(
	MAMA VARCHAR(10),
	MADT VARCHAR(10),
	TENMONAN NVARCHAR(100), CHECK(TENMONAN IS NOT NULL),
	MIEUTAMON NVARCHAR(100),
	GIA MONEY,
	TINHTRANG NVARCHAR(100), CHECK(TINHTRANG IS NOT NULL),
	TUYCHON NVARCHAR(100)

	CONSTRAINT PK_MA
	PRIMARY KEY (MAMA,MADT)
)

CREATE TABLE DONDATHANG
(
	MADH VARCHAR(10),
	TINHTRANG NVARCHAR(100), CHECK(TINHTRANG IS NOT NULL),
	HINHTHUCTHANHTOAN NVARCHAR(100),
	PHIVANCHUYEN MONEY,
	TONGTIEN MONEY,
	THOIGIAN DATETIME,
	PHANTRAMHOAHONG FLOAT,
	NGUOIDAT VARCHAR(10),
	NGUOIGIAO VARCHAR(10)

	CONSTRAINT PK_DDH
	PRIMARY KEY (MADH)
)

CREATE TABLE CHITIETDONDATHANG
(
	MADH VARCHAR(10),
	MAMA VARCHAR(10),
	MADT VARCHAR(10),
	SLMON INT, CHECK(SLMON > 0),
	DANHGIA NVARCHAR(100)

	CONSTRAINT PK_CTDDH
	PRIMARY KEY (MADH,MAMA,MADT)
)
GO
ALTER TABLE NHANVIEN
ADD
	CONSTRAINT FK_NV_TK
	FOREIGN KEY(MATK)
	REFERENCES TAIKHOAN
GO
ALTER TABLE KHACHHANG
ADD
	CONSTRAINT FK_KH_TK
	FOREIGN KEY(MATK)
	REFERENCES TAIKHOAN
GO
ALTER TABLE TAIXE
ADD
	CONSTRAINT FK_TX_TK
	FOREIGN KEY(MATK)
	REFERENCES TAIKHOAN
GO
ALTER TABLE DOITAC
ADD
	CONSTRAINT FK_DT_TK
	FOREIGN KEY(MATK)
	REFERENCES TAIKHOAN
GO
ALTER TABLE HOPDONG
ADD
	CONSTRAINT FK_HD_DT
	FOREIGN KEY(MADT)
	REFERENCES DOITAC
GO
ALTER TABLE HOPDONG
ADD
	CONSTRAINT FK_HD_NV
	FOREIGN KEY(NVDUYET)
	REFERENCES NHANVIEN
GO
ALTER TABLE CUAHANG
ADD
	CONSTRAINT FK_CH_DT
	FOREIGN KEY(MADT)
	REFERENCES DOITAC
GO
ALTER TABLE MONAN
ADD
	CONSTRAINT FK_MA_DT
	FOREIGN KEY(MADT)
	REFERENCES DOITAC
GO
ALTER TABLE DONDATHANG
ADD
	CONSTRAINT FK_DDH_KH
	FOREIGN KEY(NGUOIDAT)
	REFERENCES KHACHHANG
GO
ALTER TABLE DONDATHANG
ADD
	CONSTRAINT FK_DDH_TX
	FOREIGN KEY(NGUOIGIAO)
	REFERENCES TAIXE
GO
ALTER  TABLE CHITIETDONDATHANG
ADD
	CONSTRAINT FK_CTDDH_DDH
	FOREIGN KEY(MADH)
	REFERENCES DONDATHANG
GO
ALTER  TABLE CHITIETDONDATHANG
ADD
	CONSTRAINT FK_CTDDH_MA
	FOREIGN KEY(MAMA,MADT)
	REFERENCES MONAN
GO

-----------------------------------------------
--INSERT DATA--
-----------------------------------------------

--1.TAIKHOAN
insert into TAIKHOAN values ('TK000', 'ADMIN','12345', 0)
insert into TAIKHOAN values ('TK001', 'NHANVIEN','12345', 1)
insert into TAIKHOAN values ('TK002', 'DOITAC1','12345', 2)
insert into TAIKHOAN values ('TK003', 'DOITAC2','12345', 2)
insert into TAIKHOAN values ('TK004', 'KHACHHANG','12345', 3)
insert into TAIKHOAN values ('TK005', 'TAIXE','12345', 4)
--2.NHANVIEN (NULL: MATK)
insert into NHANVIEN values ('NV001',N'Trần Đại Quốc','tdquoc20@clc.fitus.edu.vn','0987654321','0',NULL)
insert into NHANVIEN values ('NV002',N'Dư Phát Lộc','dploc20@clc.fitus.edu.vn','0908070605','1',NULL)
--3.KHACHHANG (NULL: MATK)
insert into KHACHHANG values ('KH001',N'Nguyễn Bùi Hoàng Lam','nbhlam20@clc.fitus.edu.vn','01234567890',N'Trái Đất', NULL)
--4.TAIXE(NULL: MATK)
insert into TAIXE values ('TX001',N'Phạm Thái Bình','ptbinh20@clc.fitus.edu.vn','0808080808',N'Mặt Trăng', '222222222', '99-H77777',N'Trái Đất','12121122112121','VCB','Vietcombank', NULL)
--5.DOITAC(NULL:MATK)
insert into DOITAC values ('DT001',N'Sứ Giả Nụ Cười :)))','hahaha@gmail.com','0555555555', N'Cô Bé Quàng Khăn Đỏ',N'Nhà Bà Ngoại',1,'50-200', N'Thịt chó sói','1001001',0, NULL)
insert into DOITAC values ('DT002',N'Sứ Giả Mít Ướt :(((','huhuhu@gmail.com','0777777777', N'Chú sói bé bỏng',N'Rừng',2,'0-50', N'Nước giải khát','2002002',0, NULL)
--6.HOPDONG(NULL: MADT, NVDUYET)
insert into HOPDONG values ('HD001','2021-10-10','2022-10-10',N'Đã Duyệt', '1016193529','SCB', 'SAIGONBANK',10,NULL,NULL)
insert into HOPDONG values ('HD002','2022-10-10','2023-10-10',N'Tái Ký', '1016193529','SCB', 'SAIGONBANK',10,NULL,NULL)
insert into HOPDONG values ('HD003','2022-10-10','2023-10-10',N'Chưa Duyệt', '8147104619','BIDV', 'BIDV',10,NULL,NULL)
--7.CUAHANG 
insert into CUAHANG values ('DT001', 1, N'Sứ Giả Nụ Cười', N'Nhà Bà Ngoại', '7:00:00', '22:30:00', 1)
insert into CUAHANG values ('DT002', 1, N'Sứ Giả Mít Ướt', N'Bờ Suối', '22:30:00', '7:30:00', 1)
insert into CUAHANG values ('DT002', 2, N'Sứ Giả Mít Ướt', N'Hốc Cây', '7:30:00', '22:30:00', 0)
--8.MONAN
insert into MONAN values ('MA001','DT001',N'Cơm Chó',N'Thơm Ngon Khó Cưỡng <3',30000,N'Có Bán', NULL)
insert into MONAN values ('MA002','DT001',N'Chú Chó Mất Sức Sống',N'Chú chó tội nghiệp',10000,N'Có Bán', NULL)
insert into MONAN values ('MA001','DT002',N'Nước Mắt',N'Con quỷ khăn đỏ',15000,N'Có Bán', NULL)
insert into MONAN values ('MA002','DT002',N'Nước Biển',N'Cho người nhạt nhẽo',40000,N'Có Bán', NULL)
insert into MONAN values ('MA003','DT002',N'LY NƯỚC CAY ĐẮNG',N'Sạch lắm <3',80000 ,N'Có Bán', NULL)
--9.DONDATHANG (NULL: NGUOIDAT, NGUOIGIAO)
insert into DONDATHANG values ('DH001', N'Chờ Nhận', N'Tiền Mặt', 20000,60000,'2022-11 21-10:16:00',20,NULL,NULL)
insert into DONDATHANG values ('DH002', N'Tiếp Nhận', N'Chuyển Khoản', 8500,113500,'2022-11-21 10:14:00',20,NULL,NULL)
insert into DONDATHANG values ('DH003', N'Đã Hoàn Thành Đơn', N'Tiền Mặt', 15500,175500,'2022-11-20 10:00:00',20,NULL,NULL)
--9.CHITIETDONDATHANG
insert into CHITIETDONDATHANG values ('DH001', 'MA001', 'DT001', 1,N'CAY QUÁ')
insert into CHITIETDONDATHANG values ('DH001', 'MA002', 'DT001', 1,N'CHÊ NHA MÁ')
insert into CHITIETDONDATHANG values ('DH002', 'MA001', 'DT002', 1,N'CHUA LOÉT')
insert into CHITIETDONDATHANG values ('DH002', 'MA002', 'DT002', 1,N'M THẤY T MẶN CHƯA ;)')
insert into CHITIETDONDATHANG values ('DH002', 'MA001', 'DT001', 2,N'CƠM CHÓ NÀY KHÉT ĐẤY')
insert into CHITIETDONDATHANG values ('DH003', 'MA003', 'DT002', 2,N'ỦA NƯỚC LỌC MÀ MÁ ?!?:D!?!')
--CẬP NHẬT DỮ LIỆU

update NHANVIEN set MATK = 'TK000' where MANV = 'NV001'
update NHANVIEN set MATK = 'TK001' where MANV = 'NV002'

update DOITAC set MATK = 'TK002' where MADT = 'DT001'
update DOITAC set MATK = 'TK003' where MADT = 'DT002'

update KHACHHANG set MATK = 'TK004' where MAKH = 'KH001'

update TAIXE set MATK = 'TK005' where MATX = 'TX001'

update HOPDONG set MADT = 'DT001' where MAHD = 'HD001'
update HOPDONG set MADT = 'DT001' where MAHD = 'HD002'
update HOPDONG set MADT = 'DT002' where MAHD = 'HD003'
update HOPDONG set NVDUYET = 'NV001' where MAHD = 'HD001'
update HOPDONG set NVDUYET = 'NV002' where MAHD = 'HD002'
update HOPDONG set NVDUYET = 'NV002' where MAHD = 'HD003'

update DONDATHANG set NGUOIDAT = 'KH001' where MADH = 'DH001'
update DONDATHANG set NGUOIDAT = 'KH001' where MADH = 'DH002'
update DONDATHANG set NGUOIDAT = 'KH001' where MADH = 'DH003'
update DONDATHANG set NGUOIGIAO = 'TX001' where MADH = 'DH002'
update DONDATHANG set NGUOIGIAO = 'TX001' where MADH = 'DH003'
